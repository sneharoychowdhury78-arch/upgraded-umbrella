<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Propose Day Rhythm üíñ</title>

<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Great+Vibes&display=swap" rel="stylesheet">

<style>
*{
  box-sizing:border-box;
}

body{
  margin:0;
  overflow:hidden;
  font-family:'Patrick Hand', cursive;
  background:radial-gradient(circle at top, #ffe4f2 0%, #ff5ca2 40%, #40001f 100%);
  color:white;
  text-align:center;
}

/* Floating hearts background */
.heart{
  position:fixed;
  bottom:-50px;
  color:rgba(255,255,255,0.8);
  font-size:20px;
  animation:floatUp 6s linear infinite;
  pointer-events:none;
  z-index:1;
}

@keyframes floatUp{
  0%{transform:translateY(0) translateX(0) scale(0.6); opacity:1;}
  100%{transform:translateY(-120vh) translateX(40px) scale(1.4); opacity:0;}
}

/* Fairy lights at top */
.fairy-row{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  display:flex;
  justify-content:space-around;
  padding:10px 0;
  z-index:2;
  pointer-events:none;
}

.fairy{
  width:14px;
  height:14px;
  background:radial-gradient(circle, #fff7c2 0%, #ffdd55 40%, transparent 70%);
  border-radius:50%;
  box-shadow:0 0 8px rgba(255,240,180,0.9);
  animation:twinkle 1.5s ease-in-out infinite alternate;
}

.fairy:nth-child(odd){
  animation-duration:2.1s;
}

@keyframes twinkle{
  from{opacity:0.3; transform:translateY(0);}
  to{opacity:1; transform:translateY(4px);}
}

canvas{
  display:block;
  margin:auto;
  border-radius:20px;
  box-shadow:0 0 40px rgba(255,255,255,0.3);
  position:relative;
  z-index:3;
}

/* Shared screen styling */
.screen{
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  background:radial-gradient(circle at top, rgba(255,154,193,0.95), rgba(195,47,91,0.96));
  z-index:4;
}

/* Ring thump animation */
.ring{
  width:120px;
  height:120px;
  border-radius:50%;
  border:6px solid #ffd700;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:60px;
  margin-bottom:20px;
  box-shadow:0 0 25px rgba(255,215,0,0.8);
  animation:ringBeat 1s ease-in-out infinite;
}

@keyframes ringBeat{
  0%{transform:scale(1); box-shadow:0 0 20px rgba(255,215,0,0.5);}
  30%{transform:scale(1.1); box-shadow:0 0 35px rgba(255,215,0,1);}
  60%{transform:scale(0.98);}
  100%{transform:scale(1);}
}

h1{
  font-family:'Great Vibes',cursive;
  font-size:60px;
  margin:0 10px 10px;
}

p{
  margin:5px 10px;
  max-width:480px;
}

/* Buttons */
button{
  padding:14px 30px;
  border:none;
  border-radius:30px;
  font-size:18px;
  background:white;
  color:#ff2e63;
  cursor:pointer;
  margin-top:12px;
  box-shadow:0 8px 18px rgba(0,0,0,0.2);
  transition:transform 0.15s, box-shadow 0.15s;
}

button:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 20px rgba(0,0,0,0.25);
}

/* Popup feedback */
#popup{
  position:absolute;
  left:50%;
  top:40%;
  transform:translate(-50%,-50%);
  font-size:40px;
  pointer-events:none;
  text-shadow:0 0 20px white;
  opacity:0;
  transition:opacity 0.2s;
  z-index:5;
}

/* Win screen proposal text */
#proposalAnim{
  font-family:'Great Vibes',cursive;
  font-size:70px;
  opacity:0;
  transition:1s;
  margin-bottom:20px;
}
</style>
</head>

<body>

<!-- Fairy lights -->
<div class="fairy-row">
  <div class="fairy"></div><div class="fairy"></div><div class="fairy"></div>
  <div class="fairy"></div><div class="fairy"></div><div class="fairy"></div>
  <div class="fairy"></div><div class="fairy"></div><div class="fairy"></div>
</div>

<!-- Start Screen -->
<div id="startScreen" class="screen">
  <div class="ring">üíç</div>
  <h1>Propose Day Rhythm üíñ</h1>
  <p>Tap anywhere in time with the hearts as they cross the white line.</p>
  <p>Hit as many beats as you can to unlock the proposal!</p>
  <button onclick="startGame()">Start the Rhythm üé∂</button>
</div>

<!-- Game Canvas -->
<canvas id="c"></canvas>
<div id="popup"></div>

<!-- Win Screen -->
<div id="winScreen" class="screen" style="display:none;">
  <div id="proposalAnim">üíç</div>
  <h1>You Did It! üíñ</h1>
  <p id="proposalText">Every beat led me to you‚Ä¶ Will you be mine, always? üíï</p>
  <button onclick="restartGame()">Play Again?</button>
</div>

<!-- Lose Screen -->
<div id="loseScreen" class="screen" style="display:none;">
  <h1>Almost There üò≠</h1>
  <p>Some hearts slipped away‚Ä¶ tap a little closer to the beat and try again üíå</p>
  <button onclick="restartGame()">Try Again?</button>
</div>

<!-- Your song (same folder) -->
<audio id="song" src="song.mp3"></audio>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
const song = document.getElementById("song");
const popup = document.getElementById("popup");

let notes = [], particles = [];
let started = false, score = 0, combo = 0;

const LANES = 3;
const hitY = () => canvas.height - 150;

// Auto note spawning
const NOTE_INTERVAL = 400;     // ms between hits
let nextNoteTime = 0;          // next hit time (ms)
const SCROLL_AHEAD = 1500;     // ms it takes to fall from spawn to hit line

function resetAutoNotes(){
  notes = [];
  const firstHitTime = 2000;   // first heart reaches the line at 2s
  nextNoteTime = firstHitTime; // we will spawn it SCROLL_AHEAD ms earlier via the loop
}

function resize(){
  canvas.width = window.innerWidth * 0.95;
  canvas.height = window.innerHeight * 0.8;
}
resize();
window.onresize = resize;

/* ===== Classes ===== */
class Note{
  constructor(lane, time){
    this.lane = lane;
    this.time = time; // when it should hit the line (ms in song)
    this.y = -50;
    this.hit = false;
  }
  update(currentTime){
    const diff = this.time - currentTime; // ms until hit
    const speed = 0.4;                    // fall speed
    this.y = hitY() - diff * speed;
  }
  draw(){
    drawHeart(laneX(this.lane), this.y, 20);
  }
}

class Particle{
  constructor(x, y){
    this.x = x;
    this.y = y;
    this.life = 30;
    this.size = Math.random() * 3 + 1;
  }
  update(){
    this.life--;
    this.y += 1;
  }
  draw(){
    ctx.fillStyle = "rgba(255,255,255," + (this.life / 30) + ")";
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
  }
}

/* ===== Drawing helpers ===== */
function drawHeart(x, y, s){
  ctx.fillStyle = "#ff2e63";
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.bezierCurveTo(x - s, y - s, x - 2 * s, y + s, x, y + 2 * s);
  ctx.bezierCurveTo(x + 2 * s, y + s, x + s, y - s, x, y);
  ctx.fill();
  particles.push(new Particle(x, y));
}

function laneX(l){
  return canvas.width / (LANES + 1) * (l + 1);
}

function showPopup(text){
  popup.innerText = text;
  popup.style.opacity = 1;
  setTimeout(() => popup.style.opacity = 0, 350);
}

/* ===== Floating hearts background ===== */
function spawnFloatingHeart(){
  const heart = document.createElement("div");
  heart.className = "heart";
  heart.innerText = "‚ù§";
  heart.style.left = Math.random() * 100 + "vw";
  heart.style.animationDuration = 4 + Math.random() * 4 + "s";
  document.body.appendChild(heart);
  setTimeout(() => heart.remove(), 7000);
}
setInterval(spawnFloatingHeart, 800);

/* ===== Game flow ===== */
function startGame(){
  document.getElementById("startScreen").style.display = "none";
  document.getElementById("winScreen").style.display = "none";
  document.getElementById("loseScreen").style.display = "none";

  score = 0;
  combo = 0;
  particles = [];

  song.pause();
  song.currentTime = 0;
  resetAutoNotes();
  started = true;

  const playPromise = song.play();
  if(playPromise !== undefined){
    playPromise.catch(err => {
      console.log("Audio play blocked:", err);
    });
  }
}

song.addEventListener("ended", () => {
  if(!started) return;
  started = false;
  const requiredScore = 2000; // tweak difficulty
  if(score >= requiredScore){
    document.getElementById("winScreen").style.display = "flex";
    document.getElementById("proposalAnim").style.opacity = 1;
  }else{
    document.getElementById("loseScreen").style.display = "flex";
  }
});

/* ===== Tap detection ===== */
function tap(){
  if(!started) return;
  const current = song.currentTime * 1000;
  let hit = false;

  for(let i = 0; i < notes.length; i++){
    const n = notes[i];
    const diff = Math.abs(n.time - current);

    if(diff < 180){             // wider PERFECT window
      score += 100;
      combo++;
      showPopup("PERFECT üíñ");
      notes.splice(i, 1);
      hit = true;
      break;
    }else if(diff < 320){       // wider GOOD window
      score += 50;
      combo++;
      showPopup("GOOD üíï");
      notes.splice(i, 1);
      hit = true;
      break;
    }else if(diff < 450){       // extra OK window
      score += 20;
      combo = 0;
      showPopup("OK üíì");
      notes.splice(i, 1);
      hit = true;
      break;
    }
  }

  if(!hit){
    combo = 0;
    showPopup("MISS üíî");
  }
}
window.addEventListener("touchstart", tap);
window.addEventListener("mousedown", tap);

/* ===== Lanes + Hit Line ===== */
function drawLanes(){
  for(let i = 0; i < LANES; i++){
    const x = laneX(i);
    ctx.fillStyle = "rgba(255,255,255," + (0.08 + 0.05 * Math.sin(song.currentTime * 10 + i)) + ")";
    ctx.fillRect(x - 30, 0, 60, canvas.height);
  }
}

function drawHitLine(){
  ctx.fillStyle = "white";
  ctx.fillRect(0, hitY(), canvas.width, 5);
}

/* ===== Main Loop ===== */
function loop(){
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if(started){
    drawLanes();
    drawHitLine();

    const current = song.currentTime * 1000;

    // Spawn notes SCROLL_AHEAD ms before their intended hit time
    while(current + SCROLL_AHEAD >= nextNoteTime &&
          !isNaN(song.duration) &&
          current < song.duration * 1000){
      const lane = Math.floor(Math.random() * LANES);
      notes.push(new Note(lane, nextNoteTime)); // time = hit time
      nextNoteTime += NOTE_INTERVAL;
    }

    notes.forEach(n => {
      n.update(current);
      n.draw();
    });

    particles.forEach((p, i) => {
      p.update();
      p.draw();
      if(p.life <= 0) particles.splice(i, 1);
    });

    ctx.fillStyle = "white";
    ctx.font = "20px 'Patrick Hand'";
    ctx.fillText("Score: " + score, 20, 30);
    ctx.fillText("Combo: " + combo, 20, 60);
  }

  requestAnimationFrame(loop);
}
loop();

/* ===== Restart ===== */
function restartGame(){
  document.getElementById("winScreen").style.display = "none";
  document.getElementById("loseScreen").style.display = "none";
  document.getElementById("proposalAnim").style.opacity = 0;
  document.getElementById("startScreen").style.display = "flex";
  song.pause();
  song.currentTime = 0;
}
</script>

</body>
</html>
